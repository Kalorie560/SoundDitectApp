# 🎵 SoundDitectApp

音声異常検知Webアプリケーション - 音声ファイルアップロード型OK/NG判定システム

## 📋 概要

SoundDitectAppは、機械学習を活用した音声異常検知システムです。ユーザーが音声ファイルをアップロードすると、1秒毎の音声セグメントに対してOK（正常）/NG（異常）の判定を行い、結果を波形グラフ上に視覚的に表示します。

**🔄 Version 2.0 - ファイルアップロード専用版**
- 録音機能を削除し、より安定したファイルアップロード方式に変更
- 異なるモデルアーキテクチャに自動対応する機能を追加

### 🎯 主な機能

- 📤 **ファイルアップロード**: 様々な音声形式（WAV, MP3, FLAC, M4A, AAC, OGG）に対応
- 🔍 **自動アーキテクチャ検出**: 異なるモデル隠れ層次元に自動適応
- 🧠 **1D-CNN音声解析**: 1D CNN + Attention モデルによる1秒毎の音声分析
- 📊 **波形ビジュアライゼーション**: OK/NG結果を波形グラフ上に色分け表示
- 🎯 **信頼度表示機能**: 各判定の信頼度をリアルタイム表示・分析
- 📋 **詳細結果テーブル**: 時系列での判定結果と信頼度の一覧表示
- 🌐 **日本語インターフェース**: 完全日本語対応のWebUI
- ⚡ **シンプル設計**: 直感的で使いやすいユーザーインターフェース

## 🚀 システム要件

### 最小要件
- **OS**: Windows 10/11, macOS 10.14+, Ubuntu 18.04+
- **Python**: 3.8以上
- **RAM**: 4GB以上
- **ストレージ**: 2GB以上の空き容量

### 推奨要件
- **RAM**: 8GB以上
- **CPU**: Intel Core i5以上またはAMD Ryzen 5以上
- **ストレージ**: 5GB以上の空き容量（大きな音声ファイル用）

## 📦 インストール

### 1. リポジトリのクローン

```bash
git clone https://github.com/Kalorie560/SoundDitectApp.git
cd SoundDitectApp
```

### 2. 仮想環境の作成（推奨）

```bash
# Python仮想環境を作成
python -m venv venv

# 仮想環境を有効化
# Windows:
venv\Scripts\activate
# macOS/Linux:
source venv/bin/activate
```

### 3. 依存関係のインストール

```bash
# pipを最新バージョンにアップグレード
pip install --upgrade pip

# 必要なパッケージをインストール
pip install -r requirements.txt
```

## 🎮 使用方法

### 1. アプリケーションの起動

```bash
streamlit run app.py
```

起動後、ブラウザで `http://localhost:8501` にアクセスします。

### 2. 基本的な使い方

1. **ファイルアップロード**
   - 「音声ファイルをアップロードしてください」ボタンをクリック
   - 対応フォーマット：WAV, MP3, FLAC, M4A, AAC, OGG
   - 最大ファイルサイズ：200MB
   - 最低音声長：1秒以上

2. **分析の実行**
   - ファイルが自動的に処理・分析される
   - 進行状況がスピナーで表示される

3. **結果の確認**
   - 波形グラフでOK/NG結果を視覚的に確認
   - 詳細結果で各セグメントの判定と信頼度を確認
   - 統計情報で全体的な傾向を把握

4. **新しい分析**
   - 新しいファイルをアップロードすると結果が更新される

### 3. モデル設定

#### カスタムモデルの使用
- サイドバーでモデルファイル（.pth）をアップロード
- アーキテクチャが自動検出され、適切に読み込まれる

#### デフォルトモデル
アプリは以下の順序でモデルを検索・読み込みます：
1. `reference/best_model.pth`（最新モデル）
2. `reference/old_best_model.pth`（旧バージョンモデル）
3. `models/best_model.pth`
4. ベースラインモデル（訓練済みモデルがない場合）

### 4. 結果の見方

#### 📊 統計情報
- **総時間**: 分析した音声の総時間
- **OK（正常）**: 正常と判定されたセグメント数と平均信頼度
- **NG（異常）**: 異常と判定されたセグメント数と平均信頼度
- **平均信頼度**: 全判定の平均信頼度

#### 🎯 信頼度サマリー
- **プログレスバー**: 各秒の信頼度を視覚的に表示
- **色分け**: OK（緑）/NG（赤）で判定を表示
- **数値表示**: 0.000-1.000の範囲で信頼度を表示

#### 📋 波形グラフ
- 🟢 **緑色の背景**: OK（正常音声）と判定されたセグメント
- 🔴 **赤色の背景**: NG（異常音声）と判定されたセグメント
- **背景の濃さ**: 信頼度に応じて透明度が変化
- **信頼度バー**: グラフ下部に青いバーで信頼度を表示

#### 📋 詳細結果テーブル
- **時刻**: 各セグメントの時間位置
- **判定**: 絵文字付きのOK/NG判定
- **信頼度**: 小数点3桁での精密な信頼度
- **信頼度レベル**: 高（0.8以上）/中（0.5-0.8）/低（0.5未満）
- **確信度**: パーセント表示での確信度

## 🏗️ プロジェクト構成

```
SoundDitectApp/
├── app.py                    # メインアプリケーション（Streamlit）
├── requirements.txt          # Python依存関係
├── README.md                # このファイル
├── reference/               # 参照用モデル訓練システム
│   ├── README.md           # 訓練システム詳細説明
│   ├── config.yaml         # モデル設定ファイル
│   ├── best_model.pth      # 最新の訓練済みモデル
│   ├── old_best_model.pth  # 旧バージョンモデル（異なるアーキテクチャ）
│   ├── audio_processor.py  # 音声前処理モジュール
│   └── model_manager.py    # AIモデル管理モジュール
└── models/                 # 追加モデル保存先（任意）
    └── best_model.pth      # 代替モデルファイル
```

## 🤖 技術仕様

### モデルアーキテクチャ
- **ベースモデル**: 1D Convolutional Neural Network (CNN) + Attention機構
- **入力**: 44100サンプル（1秒間の音声、44.1kHz）
- **出力**: 2クラス分類（OK: 0, NG: 1）+ 信頼度スコア
- **前処理**: 音声正規化、長さ調整
- **信頼度計算**: Softmax確率の最大値を信頼度として出力

### 🔍 自動アーキテクチャ検出機能
アプリは保存されたモデルファイルを自動的に分析し、以下を検出します：
- **CNN層の構成**: フィルタ数、カーネルサイズ、ストライド
- **アテンション次元**: 隠れ層の次元数とヘッド数
- **全結合層**: ユニット数とドロップアウト率

これにより、`old_best_model.pth`のような異なるアーキテクチャのモデルも自動的に読み込めます。

### 技術スタック
- **フロントエンド**: Streamlit
- **機械学習**: PyTorch, torchaudio
- **音声処理**: librosa
- **データ処理**: NumPy, pandas
- **可視化**: Matplotlib

### 対応音声フォーマット
- **WAV**: 非圧縮音声（推奨）
- **MP3**: 圧縮音声（一般的）
- **FLAC**: 可逆圧縮音声（高音質）
- **M4A**: Apple形式
- **AAC**: 高効率圧縮
- **OGG**: オープンソース形式

## 🎓 モデル訓練（上級者向け）

独自のデータでモデルを訓練したい場合は、`reference/`フォルダ内の訓練システムを使用できます。

### 訓練データの準備

1. `data/`フォルダにJSONファイルを配置
2. データ形式：
```json
{
  "waveforms": [
    [0.0, 0.01, -0.01, ...],  // 44100個の音声サンプル
    [0.0, 0.02, 0.01, ...]
  ],
  "labels": ["OK", "NG"],      // 対応するラベル
  "fs": 44100                  // サンプリング周波数
}
```

### 訓練の実行

```bash
# reference フォルダに移動
cd reference

# モデルを訓練
python scripts/train_model.py
```

詳細な訓練手順については `reference/README.md` を参照してください。

## 🔧 トラブルシューティング

### よくある問題と解決方法

#### 1. ファイルアップロードでエラーが発生する
- **ファイルサイズ**: 200MB以下に制限されています
- **ファイル形式**: 対応フォーマットを確認してください
- **音声長**: 最低1秒以上の音声が必要です
- **ファイル破損**: 別の音声ファイルで試してください

#### 2. モデル読み込みエラー
- **アーキテクチャ不一致**: アプリが自動検出を試行します
- **カスタムモデル**: .pthファイルが正しいPyTorchモデルか確認
- **ファイル破損**: 別のモデルファイルで試してください

#### 3. 音声処理エラー
- **サンプリング周波数**: サイドバーで22050Hzに変更してみる
- **チャンネル数**: モノラル音声に自動変換されます
- **音声コーデック**: 対応フォーマットに変換してください

#### 4. パッケージのインストールエラー
```bash
# pipのアップグレード
pip install --upgrade pip

# 個別インストール
pip install streamlit torch torchaudio numpy pandas matplotlib librosa
```

#### 5. PyTorchクラス警告エラー
```
Examining the path of torch.classes raised: RuntimeError
```
- この警告は動作に影響しません
- アプリケーション内で自動的に抑制されます
- 気になる場合はStreamlitを最新版にアップグレード

#### 6. メモリ不足エラー
- **大きなファイル**: ファイルサイズを小さくしてください
- **システムRAM**: 4GB以上のRAMが推奨です
- **仮想メモリ**: システムの仮想メモリ設定を確認

### システム固有の問題

#### Windows
- Visual Studio Build Toolsが必要な場合があります
- Windows Defender の除外設定を確認

#### macOS
- Xcodeコマンドラインツールのインストールが必要：
```bash
xcode-select --install
```

#### Linux
- システムレベルの音声ライブラリが必要：
```bash
sudo apt-get install ffmpeg
```

## 🆕 バージョン履歴

### Version 2.0.0 (最新)
- 📤 録音機能を削除し、ファイルアップロード専用に変更
- 🔍 モデルアーキテクチャ自動検出機能を追加
- 🎯 UI/UXを大幅に改善
- 🧹 コードベースを簡素化・安定化

### Version 1.x
- 🎤 リアルタイム録音機能（非推奨）
- 📊 基本的な音声分析機能

## 🤝 貢献

プロジェクトへの貢献を歓迎します！

1. このリポジトリをフォーク
2. 機能ブランチを作成 (`git checkout -b feature/新機能`)
3. 変更をコミット (`git commit -am '新機能を追加'`)
4. ブランチにプッシュ (`git push origin feature/新機能`)
5. プルリクエストを作成

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は[LICENSE](LICENSE)ファイルを参照してください。

## 🙋‍♂️ サポート

### ドキュメント
- [基本的な使い方](#-使用方法)
- [トラブルシューティング](#-トラブルシューティング)
- [モデル訓練システム](reference/README.md)

### 問題の報告
バグ報告や機能要請は[GitHub Issues](https://github.com/Kalorie560/SoundDitectApp/issues)でお願いします。

### お問い合わせ
その他のお問い合わせは[GitHub Discussions](https://github.com/Kalorie560/SoundDitectApp/discussions)をご利用ください。

---

**SoundDitectApp v2.0** - シンプルで効果的な音声異常検知ソリューション 🎵✨