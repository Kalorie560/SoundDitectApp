# SoundDitectApp

1D CNNモデルを使用したリアルタイム音声録音・分類のStreamlitウェブアプリケーションです。

## 機能

- **リアルタイム音声録音**: `streamlit-webrtc`を使用してブラウザからマイク音声をキャプチャ
- **1D CNN分類**: 音声セグメントを1秒ごとにOK (0) またはNG (1) として分類
- **音声処理**: 音声前処理を自動処理（22050 Hzサンプリング、モノラル変換、長さ正規化）
- **可視化**: 時間領域波形グラフに色分けされたセグメントで結果を表示
- **モデルサポート**: 事前学習済みPyTorchモデル（.pthファイル）の読み込み

## インストール

1. リポジトリをクローン:
```bash
git clone https://github.com/Kalorie560/SoundDitectApp.git
cd SoundDitectApp
```

2. 依存関係をインストール:
```bash
pip install -r requirements.txt
```

## 使用方法

1. Streamlitアプリを実行:
```bash
streamlit run app.py
```

2. サイドバーを使用して学習済みモデル（.pthファイル）をアップロード

3. 「Start」をクリックして音声録音を開始

4. マイクに向かって話す - アプリは1秒ごとのチャンクをリアルタイムで処理

5. 「Stop」をクリックして録音を終了し、結果を表示

## モデル要件

アプリケーションは以下の仕様のPyTorchモデルを想定しています：

- **入力形状**: `(batch_size, channels, length) = (1, 1, 22050)`
- **出力**: 二値分類（2クラス: OK=0, NG=1）
- **アーキテクチャ**: `nn.Conv1d`レイヤーを使用した1D CNN
- **音声フォーマット**: 22050 Hzサンプリングレート、モノラルチャンネル、1秒セグメント

### サポートされるモデルアーキテクチャ

アプリケーションは自動的にモデルアーキテクチャを検出し、以下の形式をサポートします：

1. **個別レイヤーアーキテクチャ**: 
   - レイヤーが個別に定義されている（`conv1`, `conv2`, `fc1`, etc.）
   - 従来のモデル定義方式

2. **Sequential アーキテクチャ**:
   - レイヤーが`nn.Sequential`で組織化されている（`cnn.0`, `cnn.1`, `classifier.0`, etc.）
   - よりモジュラーなモデル設計

3. **Attention付きモデル**:
   - Attentionメカニズムを含むモデル（`attention.query`, `attention.key`, etc.）
   - より高度な特徴抽出

### 柔軟なモデル読み込み

- **自動アーキテクチャ検出**: モデルファイルのキーを分析して適切なアーキテクチャを自動選択
- **キーマッピング**: 異なる命名規則のモデル間での自動変換
- **部分読み込み**: 一部のレイヤーが不一致でも可能な限り読み込み
- **フォールバック機能**: 複数の読み込み戦略を順次試行

## 音声処理

アプリは以下を自動で処理します：
- 22050 Hzへのリサンプリング
- モノラル変換（ステレオ入力の場合）
- 長さ正規化（22050サンプルへのパディングまたは切り詰め）
- 1秒セグメントへのリアルタイムチャンク分割

## 結果の可視化

録音後、アプリは以下を表示します：
- 色分けされた背景の音声波形プロット
- 緑のセグメント: OK分類
- 赤のセグメント: NG分類
- 要約統計（総持続時間、OK/NG数）
- 詳細な秒単位の結果

## 技術詳細

- StreamlitとStreamlit-webrtcで構築
- モデル推論にPyTorchを使用
- torchaudioとnumpyで音声処理
- matplotlibで可視化
- スレッドセーフな音声バッファリングと処理

## トラブルシューティング

### モデル読み込みエラー

**問題**: `Missing key(s) in state_dict` または `Unexpected key(s) in state_dict` エラー

**解決方法**: 
1. アプリケーションは自動的に異なるアーキテクチャを検出し適応します
2. エラーが発生した場合、アプリは以下の順序で読み込みを試行します：
   - 厳密な読み込み (strict=True)
   - 部分読み込み (strict=False) 
   - キーマッピングによる変換
   - レガシー読み込み

**対応状況の確認**: モデル読み込み時にStreamlitアプリで以下のメッセージを確認：
- "Sequential architecture detected" - Sequential形式のモデル
- "Individual layer architecture detected" - 個別レイヤー形式のモデル
- "Attention mechanism detected" - Attention付きモデル
- "Unknown architecture - attempting key mapping" - 自動変換を試行

### 音声品質の改善

- 静かな環境での録音を推奨
- マイクとの距離を適切に保つ
- 1秒以上の音声で十分なデータを確保